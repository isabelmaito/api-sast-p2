name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    
permissions:
  contents: write

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/api-sast-p2

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test || true

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=isabelmaito_api-sast-p2
          -Dsonar.organization=isabelmaito
          -Dsonar.sources=src
          -Dsonar.tests=tests
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

    - name: Bump version and push tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        default_bump: patch

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_version.outputs.new_tag }}
        name: Release ${{ steps.tag_version.outputs.new_tag }}
        body: ${{ steps.tag_version.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Calculate Docker image version
      id: version
      run: |
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "VERSION=latest" >> $GITHUB_OUTPUT
          echo "TAG=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        else
          echo "VERSION=develop" >> $GITHUB_OUTPUT
          echo "TAG=$(git rev-parse --short HEAD)-develop" >> $GITHUB_OUTPUT
        fi

    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.version.outputs.VERSION }} .
        docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.version.outputs.VERSION }} ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.version.outputs.TAG }}

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Docker images
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/projeto-p2-backend:latest
          ${{ secrets.DOCKER_USERNAME }}/projeto-p2-backend:${{ steps.tag_version.outputs.new_tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Render
      if: success()
      run: curl "${{ secrets.RENDER_DEPLOY_HOOK }}"